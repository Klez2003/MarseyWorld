{%- extends 'root.html' -%}
{% block pagetitle -%}{{chat.name}}{%- endblock %}
{% block pagetype %}chat{% endblock %}
{% block body_attributes %}class="has_header"{% endblock %}
{% block body %}
	<link rel="stylesheet" href="{{'css/chat.css' | asset}}">
	<link rel="stylesheet" href="{{'css/orgy.css' | asset}}">
	{% include "header.html" %}
	{% include "modals/emoji.html" %}
	{% include "modals/gif.html" %}
	{% set vlink = '<a href="/id/' ~ v.id ~ '"' %}
	<div id="orgy-top-container">
		<div id="orgy-col" class="col text-left px-md-2">
			<h5 class="mt-2 mb-3 ml-1 d-mob-none" style="display:inline-block">{{orgy.title}}</h5> 
			<b class="mt-2 mb-2 ml-1 text-small d-md-none" style="display:inline-block">{{orgy.title}}</b> 

			{% if chat.id != 1 %}
				{% if v.id in chat.mod_ids %}
					<a href="/chat/{{chat.id}}/orgies" class="chat-control fas fa-tv text-muted mx-2"></a>

					<a href="/chat/{{chat.id}}/custom_css" class="chat-control fas fa-palette text-muted mx-2"></a>

					<i data-bs-html="true" data-bs-toggle="tooltip" data-bs-placement="bottom" title="<h5>Chat Commands</h5><p><code>+@grue</code> adds @grue to the chat</p><p><code>-@grue</code> removes @grue from the chat</p>{% if v.id == chat.owner_id %}<p><code>*@grue</code> makes @grue a chat mod</p><p><code>/@grue</code> removes @grue as a chat mod</p>{% endif %}" class="chat-control fas fa-terminal text-muted ml-2"></i>
				{% else %}
					<button class="px-2" type="button" data-nonce="{{g.nonce}}" data-bs-toggle="tooltip" title="{% if muting_chat %}Unmute (do it){% else %}Mute (don't do it){% endif %}" data-nonce="{{g.nonce}}" data-onclick="postToastReload(this, '/chat/{{chat.id}}/toggle_mute')">
						<i class="fas fa-bell-slash {% if muting_chat %}text-danger{% else %}text-muted{% endif %}"></i>
					</button>
				{% endif %}

				<button id="leave-private-chat" type="submit" class="btn btn-danger fl-r mt-1 mt-md-2 pt-0 px-2 mr-1 text-small-sm" data-nonce="{{g.nonce}}" data-onclick="areyousure(this)" data-areyousure="postToastReload(this, '/chat/{{chat.id}}/leave')">Leave</button>
			{% endif %}

			<div>
				<p id="orgy-file-container" class="resizable">
					{% if orgy.type == 'youtube' %}
						<iframe credentialless="true" style="border: none" sandbox="allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox allow-presentation" title="Play" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen src="{{orgy.data}}{% if orgy.end_utc %}&start={{orgy.seconds_since_starts}}{% endif %}"></iframe>
					{% elif orgy.type == 'file' %}
						<video id="orgy-file" data-created_utc="{{orgy.real_start_utc}}" controls preload="none" src="{{orgy.data}}"></video>
						<video id="break-file" class="d-none" controls preload="none" src="/assets/break.mp4" data-run="{{orgy.start_utc != orgy.real_start_utc}}"></video>
						<script defer src="{{'js/orgy_file.js' | asset}}"></script>
					{% else %}
						<iframe credentialless="true" src="{{orgy.data}}" frameborder="0" allowfullscreen></iframe>
					{% endif %}
				</p>
				{% if (orgies)|length > 1 %}
					<table class="mt-2 d-mob-none">
						<thead>
							<tr>
								<th>Title</th>
								<th>Starts on</th>
								<th>Ends on</th>
							</tr>
						</thead>
						{% for orgy in orgies %}
							<tr>
								<td>{{orgy.title}}</td>
								{% if orgy.started %}
									<td>Started</td>
								{% else %}
									<td data-time="{{orgy.start_utc}}"></td>
								{% endif %}
								<td {% if orgy.end_utc %}data-time="{{orgy.end_utc}}"{% endif %}></td>
							</tr>
						{% endfor %}
					</table>
				{% endif %}
			</div>
		</div>

		<div class="orgy-chat-window-item pl-1 pr-2">
			<div id="chat-group-template" class="d-none">
				{{macros.chat_group_template()}}
				</div>
			</div>

			<div id="chat-line-template" class="d-none">
				{{macros.chat_line_template()}}
			</div>
			{{macros.chat_window(vlink, v.group_memberships_names, v.keyword_notifs_li)}}

			{% if chat.id != 1 %}
				<div class="mx-2 d-mob-none">
					<hr class="mt-5 mb-3">
					<h5>Members ({{sorted_memberships|length}})</h5>
					<ul class="members col text-left bg-white mb-4 pb-2" style="max-width:300px;list-style-type:none">
						{% for membership in sorted_memberships %}
							{% set user = membership.user %}
							{% set patron = '' %}
							{% if user.patron %}
								{% set patron = patron + 'class="patron chat-patron" style="background-color:#' ~ user.name_color ~ '"' %}
							{% endif %}
							{% if user.pride_username(None) %}
								{% set patron = patron + ' pride_username' %}
							{% endif %}
							<li class="user-{{user.id}}">
								<a class="font-weight-bold" target="_blank" href="/@{{user.username}}" style="color:#{{user.name_color}}">
									<img loading="lazy" class="mr-1" src="/pp/{{user.id}}">
									<span {{patron | safe}}>{{user.username}}</span>
								</a>

								{% if user.id == chat.owner_id %}
									<img class="ml-1 chat-mod" data-bs-toggle="tooltip" alt="Owner" title="Owner" src="{{SITE_FULL_IMAGES}}/e/marseykingretard.webp">
								{% elif user.id in chat.mod_ids %}
									<img class="ml-1 chat-mod" data-bs-toggle="tooltip" alt="Mod" title="Mod" src="{{SITE_FULL_IMAGES}}/e/marseyjanny.webp">
								{% endif %}

								{% if membership.muted %}
									<i class="fas fa-bell-slash text-danger" data-bs-toggle="tooltip" title="Muted chat ({% if v.id == membership.user_id %}kys{% elif v.id in chat.mod_ids %}kick him{% else %}kill him{% endif %})"></i>
								{% endif %}

								<i class="d-none ml-1 text-smaller text-success online-marker online-marker-{{user.id}} fas fa-circle"></i>
							</li>
						{% endfor %}
					</ul>
				</div>
			{% endif %}
		</div>
	</div>

	<input id="chat_id" hidden value="{{chat.id}}">
	<input id="vid" hidden value="{{v.id}}">
	<input id="slurreplacer" hidden value="{{v.slurreplacer}}">
	<input id="blocked_user_ids" hidden value="{{(v.userblocks|string)[1:-1]}}">
	<input id="group_names" hidden value="{{(v.group_memberships_names|string)[1:-1]}}">
	{% if v.keyword_notifs_li %}
		<input id="keyword_notifs_li" hidden value="{{(v.keyword_notifs_li|string)[1:-1]}}">
	{% endif %}
	<script defer src="{{'js/vendor/socketio.js' | asset}}"></script>
	<script defer src="{{'js/flash.js' | asset}}"></script>
	<script defer src="{{'js/vendor/lozad.js' | asset}}"></script>
	<script defer src="{{'js/vendor/lite-youtube.js' | asset}}"></script>
	{% if not session.get("GLOBAL") %}
		<script defer src="{{'js/chat.js' | asset}}"></script>
	{% endif %}
	<input id="twitter" hidden value="{{v.twitter}}">
	<input id="reddit" hidden value="{{v.reddit}}">
	<input id="chat_id" hidden value="{{chat_id}}">
	<script defer src="{{'js/embed_twitter_reddit.js' | asset}}"></script>
{% endblock %}
